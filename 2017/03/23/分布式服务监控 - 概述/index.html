<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Life Career</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="分布式服务监控 - 概述目录
目标
概述

目标
收集并存储一定时期内的服务器系统状态、网络状态、核心组件的核心指标，常见服务（mysql、redis等）的服务指标
7*24小时对上述指标进行监控报警，对超过指定阈值的可疑指标发出报警（邮件或短信通知）。区别于dapper和pinpoint的分布式全局调用追踪
对上述指标数据提供数据报表功能，便于全面的跟踪查看系统的运行状态

概述
Applica">
<meta property="og:type" content="article">
<meta property="og:title" content="Life Career">
<meta property="og:url" content="http://yoursite.com/2017/03/23/分布式服务监控 - 概述/index.html">
<meta property="og:site_name" content="Life Career">
<meta property="og:description" content="分布式服务监控 - 概述目录
目标
概述

目标
收集并存储一定时期内的服务器系统状态、网络状态、核心组件的核心指标，常见服务（mysql、redis等）的服务指标
7*24小时对上述指标进行监控报警，对超过指定阈值的可疑指标发出报警（邮件或短信通知）。区别于dapper和pinpoint的分布式全局调用追踪
对上述指标数据提供数据报表功能，便于全面的跟踪查看系统的运行状态

概述
Applica">
<meta property="og:image" content="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/2fde37d8db8c7cd5bab1009a0e2cfb87/image.png">
<meta property="og:image" content="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/e6b93b170310e44fab86a6ea88fee96d/image.png">
<meta property="og:image" content="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/70c0f97ecb898bea9bbd0a3d82709ee2/image.png">
<meta property="og:image" content="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/cdbd4f1daf0ac4680b8b241b3022f2eb/image.png">
<meta property="og:image" content="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/65a5420a9c21575e17679f1071163cc0/image.png">
<meta property="og:image" content="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/15119d43ec776b90babfd6ad7532f8c0/image.png">
<meta property="og:updated_time" content="2017-03-30T02:14:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Life Career">
<meta name="twitter:description" content="分布式服务监控 - 概述目录
目标
概述

目标
收集并存储一定时期内的服务器系统状态、网络状态、核心组件的核心指标，常见服务（mysql、redis等）的服务指标
7*24小时对上述指标进行监控报警，对超过指定阈值的可疑指标发出报警（邮件或短信通知）。区别于dapper和pinpoint的分布式全局调用追踪
对上述指标数据提供数据报表功能，便于全面的跟踪查看系统的运行状态

概述
Applica">
<meta name="twitter:image" content="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/2fde37d8db8c7cd5bab1009a0e2cfb87/image.png">
  
    <link rel="alternate" href="/atom.xml" title="Life Career" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Life Career</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-分布式服务监控 - 概述" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/23/分布式服务监控 - 概述/" class="article-date">
  <time datetime="2017-03-23T06:58:10.000Z" itemprop="datePublished">2017-03-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="分布式服务监控-概述"><a href="#分布式服务监控-概述" class="headerlink" title="分布式服务监控 - 概述"></a>分布式服务监控 - 概述</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li>目标</li>
<li>概述</li>
</ul>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ul>
<li>收集并存储一定时期内的服务器系统状态、网络状态、核心组件的核心指标，常见服务（mysql、redis等）的服务指标</li>
<li>7*24小时对上述指标进行<font color="blue">监控报警</font>，对超过指定阈值的可疑指标发出报警（邮件或短信通知）。区别于dapper和pinpoint的分布式全局调用追踪</li>
<li>对上述指标数据提供<font color="blue">数据报表</font>功能，便于全面的跟踪查看系统的运行状态</li>
</ul>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ul>
<li><i>Application Performance Management(应用性能管理，简称APM)</i>：In the fields of information technology and systems management, application performance management is the <font color="blue">monitoring and management of performance and availability of software applications</font>. APM strives to detect and diagnose complex application performance problems to maintain an expected level of service.</li>
<li><font color="blue">商用软件</font>，目前市面上有不少商用的APM管理软件，如<a href="http://www.toushibao.com/" target="_blank" rel="external">oneAPM</a>、<a href="">透视宝</a>等。在监控的目标机器上安装agent，通过agent采集数据推送到服务商的server端，server端提供数据报表展示和监控报警功能。使用这些服务，可以快速的搭建起自己的主机和服务监控，只需要安装相应的agent，并配置相关服务的配置文件如redis、mysql等，主机本身disk、memory、cpu、traffic等指标通常默认支持，不需额外配置；缺点是价格不低，一般要几十块钱每主机每月。</li>
<li><font color="blue">开源软件</font>，我们的集群规模大约在100台左右，一年的价格算下来就在4万块左右，从节约成本的角度我们选择了开源的技术方案。另外作为一个合格的技术人员，一定要有创造一切的雄心！比较常用的开源监控软件有Nagios、Icinga、Zabbix，比较如下，还有更多其它方案可以参考这篇<a href="https://www.serverdensity.com/monitor/linux/how-to/" target="_blank" rel="external">文章</a>，以及serverfalut这篇<a href="http://serverfault.com/questions/44/what-tool-do-you-use-to-monitor-your-servers" target="_blank" rel="external">帖子</a><ul>
<li><a href="http://www.zabbix.com/" target="_blank" rel="external">Zabbix</a>：自带报表更能，安装简单</li>
<li><a href="https://www.nagios.org/" target="_blank" rel="external">Nagios</a>: 使用最广泛，支持所有平台、扩展性好，<font color="red">部署相对复杂</font>、图表需要插件扩展支持</li>
<li><a href="">Icinga2</a>: nagios的fork，是为了解决nagios的更新慢、反馈慢等问题而设立的项目。覆盖Nagios所有功能，更新快、社区活跃</li>
</ul>
</li>
<li>我们最终选用的方案是icinga，考虑的因素包括：nagios的使用广泛、icinga社区的活跃度非常高、以及icinga的分布式支持</li>
<li>icingaweb2监控示意图，<font color="red">通过这些页面可以全面的掌握集群机器和服务的动态</font><ul>
<li>首页：首页显示菜单及当前服务器和服务存在的主要问题（Service Problems)，所有的问题都会以红色警报提示 <img src="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/2fde37d8db8c7cd5bab1009a0e2cfb87/image.png" alt="image"></li>
<li>hosts: hosts菜单显示所有服务器状态<img src="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/e6b93b170310e44fab86a6ea88fee96d/image.png" alt="image"></li>
<li>hostgroups：hostgroups按分组管理所有的服务器 <img src="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/70c0f97ecb898bea9bbd0a3d82709ee2/image.png" alt="image"></li>
<li>servicegroups：按分组管理所有的服务<img src="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/cdbd4f1daf0ac4680b8b241b3022f2eb/image.png" alt="image"></li>
</ul>
</li>
</ul>
<h2 id="领域模型"><a href="#领域模型" class="headerlink" title="领域模型"></a>领域模型</h2><h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><ul>
<li>Master</li>
<li>Satelite</li>
<li>Client</li>
</ul>
<h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><ul>
<li>features<ul>
<li>通过icinga command line interface命令控制feature，管理通知（notification）、命令（command）、ido-mysql等</li>
<li><img src="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/65a5420a9c21575e17679f1071163cc0/image.png" alt="image"></li>
</ul>
</li>
<li>Template</li>
<li>Command（icinga监控命令） <ul>
<li>Check Commands</li>
<li>示例：<pre><code><br>object CheckCommand “check_redis” {<br> command = [ PluginDir + “/check_redis.pl”]<br> arguments = {<br>   “-H” = “$redis_host$”<br>   “-p” = “$redis_port$”<br>   “-x” = “$redis_pwd$”<br>   “-a” = “mem_fragmentation_ratio,connected_clients,keyspace_hits,used_memory_rss,total_connections_received,blocked_clients”<br>   “-w” = “~,100,~,300M,~,~”<br>   “-c” = “1.0:20,300,~,500M,~,~”<br> }<br>}<br></code></pre></li>
<li>Notification Commands</li>
<li>Event Commands</li>
</ul>
</li>
<li>Service配置<pre><code><br>  apply Service “check-cache-redis” {<pre><code>import &quot;generic-service&quot;
check_command = &quot;check_redis&quot;
vars.redis_host = host.address
vars.redis_port = &quot;7136&quot;
vars.redis_pwd = &quot;j^dy@&quot;
assign where host.name == &quot;icinga-cache1.jindouyun.com&quot;
</code></pre>  }<br>  </code></pre></li>
<li>groups配置，使用apply rules表达式（Apply Rules Expression)批量指定group<pre><code><br>  //服务器分组<br>  object HostGroup “cache-servers” {<pre><code>display_name = &quot;Cache Servers&quot;
assign where match(&quot;*cache*&quot;, host.name)
</code></pre>  }<br>  //服务分组<br>  object ServiceGroup “redis” {<pre><code>display_name = &quot;Redis Checks&quot;
assign where match(&quot;check_redis&quot;, service.check_command)
</code></pre>  }<br>  </code></pre></li>
</ul>
<h2 id="icinga实践"><a href="#icinga实践" class="headerlink" title="icinga实践"></a>icinga实践</h2><h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><ul>
<li>分布式</li>
<li>插件扩展</li>
<li>安全性</li>
</ul>
<h3 id="master安装"><a href="#master安装" class="headerlink" title="master安装"></a>master安装</h3><ul>
<li>安装icinga2<ul>
<li>yum install -y <a href="https://packages.icinga.com/epel/7/release/noarch/icinga-rpm-release-7-1.el7.centos.noarch.rpm" target="_blank" rel="external">https://packages.icinga.com/epel/7/release/noarch/icinga-rpm-release-7-1.el7.centos.noarch.rpm</a></li>
<li>yum install -y icinga2</li>
<li>chkconfig icinga2 on</li>
<li>service icinga2 start</li>
</ul>
</li>
<li>安装httpd<ul>
<li>yum install -y httpd</li>
<li>chkconfig httpd on</li>
<li>service httpd start</li>
</ul>
</li>
<li>安装nagios插件<ul>
<li>yum install -y nagios-plugins-all</li>
</ul>
</li>
<li>安装、初始化mysql库<ul>
<li>DB IDO（DataBase Icinga Data Output）</li>
<li>安装mysql：yum install -y mysql-server mysql &amp;&amp; chkconfig mysqld on &amp;&amp; service mysqld start &amp;&amp; mysql_secure_installation</li>
<li>yum install -y icinga2-ido-mysql &amp;&amp; icinga2 feature enable ido-mysql</li>
<li>配置文件位于/etc/icinga2/features-available，修改默认密码</li>
</ul>
</li>
<li>安装icinga web2<ul>
<li>cinga2 feature enable command</li>
<li>systemctl restart icinga2.service</li>
<li>sudo usermod -a -G icingacmd apache</li>
<li>id apache</li>
<li>sudo yum install icingaweb2 icingacli -y</li>
<li>sudo icingacli setup config webserver apache –document-root /usr/share/icingaweb2/public</li>
<li>sudo systemctl restart httpd.service</li>
<li>sudo icingacli setup token create</li>
</ul>
</li>
<li>安装高亮插件 install vim highlighting plugin<ul>
<li>yum install vim-icinga2</li>
<li>touch ~/.vimrc</li>
<li>echo “syntax on” &gt;&gt; ~/.vimrc</li>
</ul>
</li>
<li>节点设置，使用<a href="https://docs.icinga.com/icinga2/latest/doc/module/icinga2/chapter/distributed-monitoring?highlight-search=Host%20certificate%20common%20name#distributed-monitoring-security" target="_blank" rel="external">icinga2 node wizard</a><ul>
<li>注意master节点的zone.conf文件，需要修改master zone名称为“master”，不能使用默认的NodeName</li>
<li>注意生成ssl key用于master/client加密通讯</li>
</ul>
</li>
</ul>
<h3 id="client安装"><a href="#client安装" class="headerlink" title="client安装"></a>client安装</h3><ul>
<li>节点设置，使用<a href="https://docs.icinga.com/icinga2/latest/doc/module/icinga2/chapter/distributed-monitoring?highlight-search=Host%20certificate%20common%20name#distributed-monitoring-security" target="_blank" rel="external">icinga2 node wizard</a><ul>
<li>连接的建立方式，一般从master/satelite机器向client机器建立连接，client机器不需要建立向master/satelite机器的连接（不需要知道master/satelite机器连接）</li>
</ul>
</li>
</ul>
<h3 id="服务器上线监控"><a href="#服务器上线监控" class="headerlink" title="服务器上线监控"></a>服务器上线监控</h3><ul>
<li>定时通过网络查看服务器是否在线</li>
<li><img src="https://code.aliyun.com/jindouyuncode/jdy-solution-master/uploads/15119d43ec776b90babfd6ad7532f8c0/image.png" alt="image"></li>
<li>hostalive 默认的服务器监控命令<pre><code><br>object Host “icinga-cache1.jindouyun.com” {<br>check_command = “hostalive”<br>address = “10.28.204.99”<br>vars.client_endpoint = name //follows the convention that host name == endpoint name<br>vars.type = “cache”<br>}<br></code></pre></li>
<li>ssh 通过指定端口连接服务器，确定服务器是否在线<pre><code><br>object Host “icinga-train-pricenode04.jindouyun.com” {<br>check_command = “ssh”<br>vars.client_endpoint = name<br>vars.ssh_address = “221.1.1.1”<br>vars.ssh_port = “12345”<br>vars.type = “node”<br>}<br></code></pre></li>
</ul>
<h3 id="redis监控"><a href="#redis监控" class="headerlink" title="redis监控"></a>redis监控</h3><h3 id="ssdb监控"><a href="#ssdb监控" class="headerlink" title="ssdb监控"></a>ssdb监控</h3><h3 id="外部插件"><a href="#外部插件" class="headerlink" title="外部插件"></a>外部插件</h3><ul>
<li>icinga大量使用perl脚本作为外部插件的实现方式，安装perl<ul>
<li>安装CPAN：yum install perl-CPAN</li>
<li>cpan:&gt; force install Redis</li>
<li>下载插件脚本并赋予执行权限</li>
</ul>
</li>
<li>常用外部插件<ul>
<li>报表：graphite</li>
<li>nagios-plugin自带的check_redis.pl等插件</li>
<li>自己实现短信插件（TODO）</li>
</ul>
</li>
</ul>
<h1 id="高级主题"><a href="#高级主题" class="headerlink" title="高级主题"></a>高级主题</h1><h2 id="load过高问题"><a href="#load过高问题" class="headerlink" title="load过高问题"></a>load过高问题</h2><h2 id="集群搭设"><a href="#集群搭设" class="headerlink" title="集群搭设"></a>集群搭设</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/03/23/分布式服务监控 - 概述/" data-id="cjps0hy9m000cs6qharzph80x" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/04/27/操作系统/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2016/09/24/Continuous-Integration-Based-On-Aliyun-Crp/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Continuous Integration Based On Aliyun Crp</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/bigdata/">bigdata</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/">elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell-linux-ops/">shell,linux,ops</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术内幕/">技术内幕</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/用户触达/">用户触达</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/笔记/">笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/运维-DevOps/">运维,DevOps</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/bigdata/" style="font-size: 10px;">bigdata</a> <a href="/tags/elasticsearch/" style="font-size: 20px;">elasticsearch</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/shell-linux-ops/" style="font-size: 10px;">shell,linux,ops</a> <a href="/tags/技术内幕/" style="font-size: 20px;">技术内幕</a> <a href="/tags/用户触达/" style="font-size: 10px;">用户触达</a> <a href="/tags/笔记/" style="font-size: 20px;">笔记</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/运维-DevOps/" style="font-size: 10px;">运维,DevOps</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/01/20/笔记：redis设计与实现/">笔记：redis设计与实现</a>
          </li>
        
          <li>
            <a href="/2019/01/20/常见设计模式总结/">常用设计模式总结</a>
          </li>
        
          <li>
            <a href="/2019/01/20/笔记——《ElasticSearch技术内幕》/">笔记——《ElasticSearch技术内幕》</a>
          </li>
        
          <li>
            <a href="/2018/12/20/服务集群异常监控/">服务监控</a>
          </li>
        
          <li>
            <a href="/2018/12/20/旅行基础数据搜索/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 SeventyNine<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>